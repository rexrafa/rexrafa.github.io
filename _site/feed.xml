<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.9.5">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2025-12-26T17:44:42-03:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Rafael Oliveira‚Äôs Tech Blog</title><subtitle>Insights on AWS, DevOps, and AI</subtitle><author><name>Rafael Oliveira</name></author><entry><title type="html">Speeding up ECS bootstrap with Seekable OCI (SOCI)</title><link href="http://localhost:4000/2025/12/26/speed-up-ecs-start/" rel="alternate" type="text/html" title="Speeding up ECS bootstrap with Seekable OCI (SOCI)" /><published>2025-12-26T09:00:00-03:00</published><updated>2025-12-26T09:00:00-03:00</updated><id>http://localhost:4000/2025/12/26/speed-up-ecs-start</id><content type="html" xml:base="http://localhost:4000/2025/12/26/speed-up-ecs-start/"><![CDATA[<h2 id="introduction">Introduction</h2>

<p>I recently worked on a real-time communication system that needed to scale quickly during user spikes. We did the usual optimizations‚Äîtuning health check intervals, keeping images small<strong>, and trimming container startup paths‚Äîbut task launch time on **AWS Fargate</strong> was still a bottleneck during rapid scale-out.</p>

<p>That‚Äôs when I found <strong>Seekable OCI (SOCI)</strong>: a way to <em>lazy load</em> container images so a task can start before the full image is downloaded. In this post, I‚Äôll focus on the practical part: how to generate and ship SOCI artifacts reliably in CI/CD (with multi-arch images), and a couple of sharp edges I hit along the way.</p>

<hr />
<h2 id="where-soci-helps-in-the-ecs-task-lifecycle">Where SOCI helps in the ECS task lifecycle</h2>

<p>If you look at the ECS task lifecycle, the part we care about is <code class="language-plaintext highlighter-rouge">ACTIVATING</code>, where the image is pulled from ECR and the container is started (<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-lifecycle-explanation.html">ECS task lifecycle docs</a>).</p>

<p>With SOCI, the platform can start the container sooner by fetching only the pieces of the image needed for startup. AWS has a great deep dive on how it works under the hood:</p>
<ul>
  <li>Lazy loading on Fargate: <a href="https://aws.amazon.com/blogs/containers/under-the-hood-lazy-loading-container-images-with-seekable-oci-and-aws-fargate/">Under the hood: lazy loading container images with SOCI and AWS Fargate</a></li>
</ul>

<p>In my case, this reduced scale-out latency by ~40% (your results will vary based on image size and what your app touches at boot).</p>

<hr />
<h2 id="soci-index-manifests-v1-vs-v2-and-why-v2-matters">SOCI index manifests: v1 vs v2 (and why v2 matters)</h2>

<p>Before diving into the implementation, it‚Äôs worth understanding why there are two versions of SOCI index manifests‚Äîand why <strong>this post focuses exclusively on v2</strong>.</p>

<p><strong>SOCI v1</strong> stored the SOCI index as a <em>separate artifact</em> loosely coupled to the container image. This could cause inconsistent deployments: during a rollout, some tasks might lazy load while others fell back to full image downloads if the index was missing or out of sync.</p>

<p><strong>SOCI v2</strong> solves this by binding the image and its SOCI index together via an OCI image index. This improves deployment consistency and makes replication/lifecycle management more reliable. For new implementations, v2 is the clear choice.</p>

<p>AWS has a detailed write-up on the differences:</p>
<ul>
  <li><a href="https://aws.amazon.com/blogs/containers/improving-amazon-ecs-deployment-consistency-with-soci-index-manifest-v2/">Improving Amazon ECS deployment consistency with SOCI Index Manifest v2</a></li>
</ul>

<p>Key requirements for v2:</p>
<ul>
  <li><strong>SOCI CLI v0.10+</strong> (we use v0.12.1 in this post)</li>
  <li><strong>AWS Fargate platform version 1.4.0+</strong></li>
  <li>Generating a SOCI v2 artifact updates the <em>image manifest</em> with annotations, so you‚Äôll see a new image digest even though the filesystem layers don‚Äôt change</li>
</ul>

<hr />
<h2 id="cicd-workflow-github-actions-for-multi-arch-images--soci">CI/CD workflow (GitHub Actions) for multi-arch images + SOCI</h2>

<p>My goal was to support <strong>linux/amd64</strong> and <strong>linux/arm64</strong> with one pipeline. Docker Buildx makes multi-platform builds straightforward, but the SOCI CLI operates on images in a <strong>containerd</strong> image store‚Äîso you typically end up with this flow:</p>

<pre><code class="language-mermaid">flowchart TD
    A[GitHub Actions Workflow] --&gt; B[Checkout source]
    B --&gt; C[Configure AWS credentials]
    C --&gt; D[Login to Amazon ECR]
    D --&gt; E[Build multi-arch image]
    E --&gt; F[Import into containerd]
    F --&gt; G[Generate SOCI artifact]
    G --&gt; H[Push to ECR]
    H --&gt; I[Deploy to ECS]
</code></pre>

<p>If you want a working reference implementation, AWS provides an end-to-end toolbox (including CI/CD examples):</p>
<ul>
  <li>https://github.com/aws-samples/aws-fargate-seekable-oci-toolbox/tree/main/soci-codepipeline</li>
</ul>

<hr />
<h2 id="the-why-do-i-need-containerdctr-part">The ‚Äúwhy do I need containerd/ctr?‚Äù part</h2>

<p>The SOCI CLI works with images stored in containerd. In GitHub Actions, that usually means:</p>
<ul>
  <li>Set up containerd</li>
  <li>Build the image with Buildx to an OCI archive (<code class="language-plaintext highlighter-rouge">type=oci,dest=...</code>)</li>
  <li>Import the archive into containerd with <code class="language-plaintext highlighter-rouge">ctr</code></li>
  <li>Generate the SOCI artifact from the containerd image store</li>
  <li>Push the result to ECR</li>
</ul>

<hr />
<h2 id="a-common-auth-pitfall-with-ecr-credentials">A common auth pitfall with ECR credentials</h2>

<p>If you‚Äôre following older SOCI examples (based on v1), you might see <code class="language-plaintext highlighter-rouge">soci push</code> used to push the SOCI artifact separately. With <strong>SOCI v2</strong>, this isn‚Äôt necessary‚Äî<code class="language-plaintext highlighter-rouge">soci convert</code> creates a unified image index, and you push everything with <code class="language-plaintext highlighter-rouge">ctr images push</code>.</p>

<p>However, I initially hit credential errors like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>soci: failed to fetch list of referrers: ... basic credential not found
</code></pre></div></div>

<p>The fix was ensuring <code class="language-plaintext highlighter-rouge">aws-actions/amazon-ecr-login@v2</code> runs before any SOCI operations:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Login to Amazon ECR</span>
  <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v2</span>
</code></pre></div></div>

<p>This action writes valid ECR credentials to <code class="language-plaintext highlighter-rouge">~/.docker/config.json</code>. Even though <code class="language-plaintext highlighter-rouge">ctr images push</code> accepts explicit <code class="language-plaintext highlighter-rouge">--user</code> flags, the SOCI CLI queries the registry during <code class="language-plaintext highlighter-rouge">soci convert</code> and relies on Docker credential helpers. Once the ECR login action runs, everything ‚Äújust works.‚Äù</p>

<hr />
<h2 id="a-minimal-github-actions-example-buildx--containerd--soci-v2--ecr">A minimal GitHub Actions example (Buildx ‚Üí containerd ‚Üí SOCI v2 ‚Üí ECR)</h2>

<p>Below is a simplified version of the pipeline that worked reliably for me using <strong>SOCI index manifest v2</strong> via <strong><code class="language-plaintext highlighter-rouge">soci convert</code></strong>. It‚Äôs designed as a reusable workflow‚Äîyou pass in your ECR registry, repository name, and image tag.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">[Reusable]:</span><span class="nv"> </span><span class="s">ECR</span><span class="nv"> </span><span class="s">Build</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">Push</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">SOCI"</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">workflow_call</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">checkout_ref</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Git</span><span class="nv"> </span><span class="s">ref</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">checkout</span><span class="nv"> </span><span class="s">(branch,</span><span class="nv"> </span><span class="s">tag,</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">SHA)"</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">aws_region</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">AWS</span><span class="nv"> </span><span class="s">region"</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">ecr_registry</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ECR</span><span class="nv"> </span><span class="s">registry,</span><span class="nv"> </span><span class="s">e.g.</span><span class="nv"> </span><span class="s">123.dkr.ecr.us-east-1.amazonaws.com"</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">ecr_repository</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ECR</span><span class="nv"> </span><span class="s">repository</span><span class="nv"> </span><span class="s">name"</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">image_tag</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Tag</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">apply</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">image</span><span class="nv"> </span><span class="s">(usually</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">SHA)"</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">context</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Docker</span><span class="nv"> </span><span class="s">build</span><span class="nv"> </span><span class="s">context"</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./"</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">dockerfile</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Dockerfile</span><span class="nv"> </span><span class="s">path"</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./Dockerfile"</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">platforms</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Comma-separated</span><span class="nv"> </span><span class="s">target</span><span class="nv"> </span><span class="s">platforms"</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s2">"</span><span class="s">linux/amd64,linux/arm64"</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
      <span class="na">soci_release</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">SOCI</span><span class="nv"> </span><span class="s">CLI</span><span class="nv"> </span><span class="s">release"</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">false</span>
        <span class="na">default</span><span class="pi">:</span> <span class="s2">"</span><span class="s">v0.12.1"</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">string</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">role_to_assume</span><span class="pi">:</span>
        <span class="na">required</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">image_uri</span><span class="pi">:</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Full</span><span class="nv"> </span><span class="s">image</span><span class="nv"> </span><span class="s">URI</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">SHA</span><span class="nv"> </span><span class="s">tag"</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s">$</span>

<span class="na">permissions</span><span class="pi">:</span>
  <span class="na">id-token</span><span class="pi">:</span> <span class="s">write</span>
  <span class="na">contents</span><span class="pi">:</span> <span class="s">read</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">image</span><span class="pi">:</span> <span class="s">$</span>
      <span class="na">image_base</span><span class="pi">:</span> <span class="s">$</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v5</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">ref</span><span class="pi">:</span> <span class="s">$</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure AWS credentials using OIDC</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v4</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">role-to-assume</span><span class="pi">:</span> <span class="s">$</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">$</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Login to Amazon ECR</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">login-ecr</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up containerd</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">crazy-max/ghaction-setup-containerd@v3</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install soci cli</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">lerentis/soci-installer@v1.1.0</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">soci-release</span><span class="pi">:</span> <span class="s">$</span>
          <span class="na">install-dir</span><span class="pi">:</span> <span class="s">/usr/local/bin</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Docker Buildx</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/setup-buildx-action@v3</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Determine tags</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">tag-definition</span>
        <span class="na">shell</span><span class="pi">:</span> <span class="s">bash</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">set -euo pipefail</span>

          <span class="s">IMAGE_BASE="$/$"</span>
          <span class="s">IMAGE="${IMAGE_BASE}:$"</span>

          <span class="s">echo "image=${IMAGE}" &gt;&gt; "$GITHUB_OUTPUT"</span>
          <span class="s">echo "image_base=${IMAGE_BASE}" &gt;&gt; "$GITHUB_OUTPUT"</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build image (OCI tar)</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/build-push-action@v6</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">context</span><span class="pi">:</span> <span class="s">$</span>
          <span class="na">file</span><span class="pi">:</span> <span class="s">$</span>
          <span class="na">platforms</span><span class="pi">:</span> <span class="s">$</span>
          <span class="na">push</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">outputs</span><span class="pi">:</span> <span class="s">type=oci,dest=/tmp/image.tar</span>
          <span class="na">tags</span><span class="pi">:</span> <span class="s2">"</span><span class="s">$:local-build"</span>
          <span class="na">cache-from</span><span class="pi">:</span> <span class="s">type=gha</span>
          <span class="na">cache-to</span><span class="pi">:</span> <span class="s">type=gha,mode=max</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create and push Image and SOCI indexes to ECR</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">ECR_PASSWORD=$(aws ecr get-login-password --region "$")</span>
          <span class="s">IMAGE="$:local-build"</span>
          <span class="s">IMAGE_SOCI="$"</span>

          <span class="s">sudo ctr i import --base-name "${IMAGE}" --digests --all-platforms /tmp/image.tar</span>

          <span class="s"># Generate SOCI index manifest v2 (requires SOCI v0.10+)</span>
          <span class="s"># This creates an OCI index that ties the image + SOCI index together.</span>
          <span class="s">sudo soci convert "${IMAGE}" "${IMAGE_SOCI}"</span>

          <span class="s"># Push the final tag. This publishes the image index plus related manifests/artifacts.</span>
          <span class="s">sudo -E ctr images push --user "AWS:${ECR_PASSWORD}" "${IMAGE_SOCI}"</span>
</code></pre></div></div>

<p>After pushing, reference the final image tag in your ECS task definition. There are no extra flags to ‚Äúenable‚Äù SOCI‚ÄîFargate automatically uses lazy loading when the image has a SOCI artifact attached. See the <a href="https://aws.amazon.com/blogs/containers/improving-amazon-ecs-deployment-consistency-with-soci-index-manifest-v2/">AWS v2 blog post</a> for details on how Fargate detects and uses SOCI indexes.</p>

<hr />
<h2 id="closing-thoughts">Closing thoughts</h2>

<p>SOCI was a ‚Äúlow-effort, high-impact‚Äù improvement for my workload: no application code changes, but noticeably faster task readiness during scale-out.</p>

<p>If you‚Äôre evaluating it, I‚Äôd start by ensuring you‚Äôre on <strong>SOCI index manifest v2</strong> and validating your workload on the Fargate platform version you run today. From there, the main work is getting CI/CD to build multi-arch images, run SOCI generation in a containerd image store, and push the right artifact to ECR.</p>

<hr />
<h2 id="further-reading">Further reading</h2>

<ul>
  <li><a href="https://aws.amazon.com/blogs/containers/improving-amazon-ecs-deployment-consistency-with-soci-index-manifest-v2/">Improving Amazon ECS deployment consistency with SOCI Index Manifest v2</a> ‚Äî Deep dive into why v2 exists and how it improves consistency</li>
  <li><a href="https://github.com/aws-samples/aws-fargate-seekable-oci-toolbox/tree/main/soci-codepipeline">AWS Fargate SOCI Toolbox</a> ‚Äî Reference CI/CD pipelines and IaC templates from AWS</li>
  <li><a href="https://medium.com/@ankit.deo/soci-indexes-for-faster-ecs-deployments-with-amazon-ecr-1bd082032244">SOCI Indexes for Faster ECS Deployments</a> ‚Äî Another practitioner‚Äôs walkthrough</li>
</ul>]]></content><author><name>Rafa Oliveira</name></author><category term="Container" /><category term="aws" /><category term="Container" /><category term="ECS" /><category term="CI/CD" /><category term="ECR" /><category term="scalability" /><category term="Github Action" /><summary type="html"><![CDATA[Introduction]]></summary></entry><entry><title type="html">4 Things I Learned Managing a WebSocket Platform at Scale</title><link href="http://localhost:4000/2025/06/09/websocket-at-scale/" rel="alternate" type="text/html" title="4 Things I Learned Managing a WebSocket Platform at Scale" /><published>2025-06-09T09:00:00-03:00</published><updated>2025-06-09T09:00:00-03:00</updated><id>http://localhost:4000/2025/06/09/websocket-at-scale</id><content type="html" xml:base="http://localhost:4000/2025/06/09/websocket-at-scale/"><![CDATA[<h2 id="introduction">Introduction</h2>

<p>Over the past two years, I‚Äôve managed a real-time platform with WebSocket applications handling more than 8 million open connections and processing over 50,000 RPS.</p>

<p>In this blog post, I want to share 4 key lessons learned while managing this platform. While our infrastructure ran on Kubernetes, these insights apply to any WebSocket deployment on AWS.</p>

<hr />

<h2 id="1-dont-trust-the-aws-ec2-up-to-network-bandwidth">1. Don‚Äôt Trust the AWS EC2 ‚ÄúUp to‚Äù Network Bandwidth</h2>

<p>When selecting an instance type, you might choose a <code class="language-plaintext highlighter-rouge">c5.2xlarge</code> because it meets your CPU/Memory requirements and advertises ‚ÄúUp to 10 Gbps‚Äù network bandwidth. However, AWS documentation clearly states:</p>

<blockquote>
  <p>Instances marked with ‚ÄúUp to‚Äù Network Bandwidth have a baseline bandwidth and can use a network I/O credit mechanism to burst beyond their baseline bandwidth on a best effort basis.</p>
</blockquote>

<p>This means you shouldn‚Äôt expect to sustain 10 Gbps for extended periods.</p>

<h3 id="finding-the-real-baseline">Finding the Real Baseline</h3>

<p>You can check the actual baseline bandwidth using this AWS CLI command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws ec2 describe-instance-types <span class="se">\</span>
    <span class="nt">--filters</span> <span class="s2">"Name=instance-type,Values=c5.*"</span> <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"InstanceTypes[].[InstanceType, NetworkInfo.NetworkPerformance, NetworkInfo.NetworkCards[0].BaselineBandwidthInGbps] | sort_by(@,&amp;[2])"</span> <span class="se">\</span>
    <span class="nt">--output</span> table
</code></pre></div></div>

<p>This returns:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------
|           DescribeInstanceTypes           |
+--------------+--------------------+-------+
|  c5.large    |  Up to 10 Gigabit  |  0.75 |
|  c5.xlarge   |  Up to 10 Gigabit  |  1.25 |
|  c5.2xlarge  |  Up to 10 Gigabit  |  2.5  |
|  c5.4xlarge  |  Up to 10 Gigabit  |  5.0  |
|  c5.9xlarge  |  12 Gigabit        |  12.0 |
|  c5.12xlarge |  12 Gigabit        |  12.0 |
|  c5.18xlarge |  25 Gigabit        |  25.0 |
|  c5.24xlarge |  25 Gigabit        |  25.0 |
|  c5.metal    |  25 Gigabit        |  25.0 |
+--------------+--------------------+-------+
</code></pre></div></div>

<p>Notice that a <code class="language-plaintext highlighter-rouge">c5.2xlarge</code> has a real baseline of only 2.5 Gbps instead of the advertised 10 Gbps. Choose instance types based on your actual network requirements.</p>

<p>üí° <strong>Tip</strong>: Consider the <code class="language-plaintext highlighter-rouge">n</code> instance variants (like <code class="language-plaintext highlighter-rouge">c5n</code>) which offer better network bandwidth baselines.</p>

<hr />

<h2 id="2-monitor-ec2-network-throttling">2. Monitor EC2 Network Throttling</h2>

<p>Even with the right instance type, you might see packets being queued or dropped. Use <code class="language-plaintext highlighter-rouge">ethtool</code> to investigate network throttling:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ethtool <span class="nt">-S</span> eth0 | <span class="nb">grep </span>exceeded
    bw_in_allowance_exceeded: 5976
    bw_out_allowance_exceeded: 70727915
    pps_allowance_exceeded: 3316
    conntrack_allowance_exceeded: 0
    linklocal_allowance_exceeded: 0
</code></pre></div></div>

<h3 id="understanding-the-metrics">Understanding the Metrics</h3>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">bw_in_allowance_exceeded</code></strong>:  High values indicate incoming throttling</li>
  <li><strong><code class="language-plaintext highlighter-rouge">bw_out_allowance_exceeded</code></strong>: High values indicate egress throttling</li>
  <li><strong><code class="language-plaintext highlighter-rouge">pps_allowance_exceeded</code></strong>: Too many small packets hitting rate limits</li>
  <li><strong><code class="language-plaintext highlighter-rouge">conntrack_allowance_exceeded</code></strong>: Connection tracking table full (should be 0)</li>
  <li><strong><code class="language-plaintext highlighter-rouge">linklocal_allowance_exceeded</code></strong>: Link-local traffic limit exceeded (should be 0)</li>
</ul>

<p>üí° <strong>Tip</strong>: Monitor these values with CloudWatch and set up alerts. Packet retransmission significantly slows down WebSocket applications.</p>

<hr />

<h2 id="3-tune-conntrack-for-long-lived-connections">3. Tune Conntrack for Long-Lived Connections</h2>

<p>WebSocket applications maintain long-lived connections that can exhaust the Linux connection tracking table, causing new connections to be dropped.</p>

<h3 id="check-current-usage">Check Current Usage</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Current tracked connections</span>
<span class="nb">cat</span> /proc/sys/net/netfilter/nf_conntrack_count

<span class="c"># Maximum allowed connections  </span>
<span class="nb">cat</span> /proc/sys/net/netfilter/nf_conntrack_max

<span class="c"># Usage percentage</span>
<span class="nb">echo</span> <span class="s2">"scale=2; </span><span class="si">$(</span><span class="nb">cat</span> /proc/sys/net/netfilter/nf_conntrack_count<span class="si">)</span><span class="s2"> * 100 / </span><span class="si">$(</span><span class="nb">cat</span> /proc/sys/net/netfilter/nf_conntrack_max<span class="si">)</span><span class="s2">"</span> | bc
</code></pre></div></div>

<h3 id="increase-the-limits-for-high-load-environments">Increase the Limits for High-Load Environments</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># For high-load WebSocket environments, increase significantly</span>
<span class="c"># Rule of thumb: 4√ó expected concurrent connections, considering CPU cores</span>
<span class="nb">sudo </span>sysctl <span class="nt">-w</span> net.netfilter.nf_conntrack_max<span class="o">=</span>524288

<span class="c"># Make persistent</span>
<span class="nb">echo</span> <span class="s2">"net.netfilter.nf_conntrack_max = 524288"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/sysctl.conf
</code></pre></div></div>

<h3 id="optimize-for-websocket-applications">Optimize for WebSocket Applications</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Reduce timeout for established connections (2 hours instead of 5 days)</span>
<span class="nb">echo</span> <span class="s2">"net.netfilter.nf_conntrack_tcp_timeout_established = 7200"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/sysctl.conf

<span class="c"># Optimize connection cleanup</span>
<span class="nb">echo</span> <span class="s2">"net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/sysctl.conf

<span class="c"># Increase hash table size for better performance with many connections</span>
<span class="nb">echo</span> <span class="s2">"net.netfilter.nf_conntrack_buckets = 65536"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/sysctl.conf
</code></pre></div></div>

<p>üí° <strong>Tip</strong>: Set <code class="language-plaintext highlighter-rouge">nf_conntrack_max</code> based on your instance‚Äôs CPU cores and memory. For high-load environments, use: <code class="language-plaintext highlighter-rouge">(CPU cores √ó 16384)</code> as a starting point, then adjust based on actual usage and available memory.</p>

<hr />

<h2 id="4-avoid-route53-dns-resolution-limits">4. Avoid Route53 DNS Resolution Limits</h2>

<p>Each network interface can only send <a href="https://docs.aws.amazon.com/whitepapers/latest/hybrid-cloud-dns-options-for-vpc/constraints.html#:~:text=Each%20network%20interface%20in%20an,provided%20DNS%20server%20every%20second.">1024 packets per second</a> to the Amazon-provided DNS server. This becomes a bottleneck for applications making frequent external API calls.</p>

<h3 id="kubernetes-solution">Kubernetes Solution</h3>

<p>Deploy <a href="https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/">nodelocaldns</a> to cache DNS queries locally and reduce latency. In high-load environments, it‚Äôs recommended to enable <code class="language-plaintext highlighter-rouge">force_tcp</code> to avoid issues caused by dropped or timed-out UDP packets, ensuring more reliable DNS resolution.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nodelocaldns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">Corefile</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">cluster.local:53 {</span>
        <span class="s">errors</span>
        <span class="s">cache {</span>
            <span class="s">success 9984 30</span>
            <span class="s">denial 9984 5</span>
        <span class="s">}</span>
        <span class="s">reload</span>
        <span class="s">loop</span>
        <span class="s">bind 169.254.20.10</span>
        <span class="s">forward . __PILLAR__CLUSTER__DNS__ {</span>
            <span class="s">force_tcp</span>
        <span class="s">}</span>
        <span class="s">prometheus :9253</span>
        <span class="s">health 169.254.20.10:8080</span>
    <span class="s">}</span>
</code></pre></div></div>

<h3 id="ec2-instance-solution">EC2 Instance Solution</h3>

<p>Set up a local DNS cache using bind9:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Install bind9</span>
<span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> <span class="nb">bind </span>bind-utils

<span class="c"># Configure as caching nameserver</span>
<span class="nb">sudo tee</span> /etc/named.conf <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
options {
    listen-on port 53 { 127.0.0.1; };
    directory "/var/named";
    recursion yes;
    allow-query { localhost; };
    forwarders { 169.254.169.253; };
    forward only;
};
</span><span class="no">EOF

</span><span class="c"># Update /etc/resolv.conf</span>
<span class="nb">echo</span> <span class="s2">"nameserver 127.0.0.1"</span> | <span class="nb">sudo tee</span> /etc/resolv.conf

<span class="c"># Start and enable bind</span>
<span class="nb">sudo </span>systemctl start named
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>named
</code></pre></div></div>

<p>üí° <strong>Tip</strong>: Monitor DNS query patterns and cache hit rates to optimize your caching strategy.</p>

<hr />

<h2 id="conclusion">Conclusion</h2>

<p>Managing WebSocket applications at scale requires understanding these AWS networking limitations:</p>

<ol>
  <li><strong>Know your real network capacity</strong> - Don‚Äôt rely on ‚Äúup to‚Äù bandwidth specifications</li>
  <li><strong>Monitor network throttling</strong> - Use <code class="language-plaintext highlighter-rouge">ethtool</code> and set up CloudWatch alerts</li>
  <li><strong>Tune conntrack for long-lived connections</strong> - Scale limits based on connection patterns</li>
  <li><strong>Implement DNS caching</strong> - Avoid Route53 rate limits with local DNS caching</li>
</ol>

<p>These optimizations helped us maintain stable performance with 8M+ concurrent connections during traffic spikes. Always test these changes in staging environments that mirror your production load.</p>

<hr />

<p>In my next post I‚Äôll talk about the challenges of scaling up and down this environment.</p>

<p><em>Have you encountered similar challenges scaling WebSocket applications? Share your experiences in the comments below.</em></p>

<p><em>This blog was written by :brain: + :robot_face:</em></p>]]></content><author><name>Rafa Oliveira</name></author><category term="Network" /><category term="aws" /><category term="network" /><category term="DNS" /><category term="EC2" /><category term="websocket" /><category term="scalability" /><summary type="html"><![CDATA[Introduction]]></summary></entry><entry><title type="html">Welcome to My Tech Blog</title><link href="http://localhost:4000/2025/06/09/welcome-to-my-blog/" rel="alternate" type="text/html" title="Welcome to My Tech Blog" /><published>2025-06-09T09:00:00-03:00</published><updated>2025-06-09T09:00:00-03:00</updated><id>http://localhost:4000/2025/06/09/welcome-to-my-blog</id><content type="html" xml:base="http://localhost:4000/2025/06/09/welcome-to-my-blog/"><![CDATA[<p>Hey there! Welcome to my tech blog. I‚Äôm Rafael, a Engineer passionate about cloud architecture and automation. Here, I‚Äôll be sharing insights about AWS,DevOps practices, and emerging technologies.</p>

<h2 id="what-to-expect">What to Expect</h2>

<p>Expect posts covering:</p>
<ul>
  <li>GenAI</li>
  <li>Cloud Architecture &amp; AWS</li>
  <li>DevOps Best Practices</li>
  <li>Infrastructure as Code</li>
  <li>Kubernetes &amp; Containerization</li>
  <li>Performance Optimization</li>
  <li>Security in the Cloud</li>
</ul>

<p>Follow me on <a href="https://linkedin.com/in/rafavinicius">LinkedIn</a> for more tech insights and updates. Looking forward to sharing knowledge and experiences with you!</p>]]></content><author><name>Rafa Oliveira</name></author><category term="general" /><category term="blog" /><summary type="html"><![CDATA[Hey there! Welcome to my tech blog. I‚Äôm Rafael, a Engineer passionate about cloud architecture and automation. Here, I‚Äôll be sharing insights about AWS,DevOps practices, and emerging technologies.]]></summary></entry></feed>